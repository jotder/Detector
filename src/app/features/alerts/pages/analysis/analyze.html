<div class="main-container relative">
  <!-- Top Toolbar -->
  <div class="top-toolbar flex justify-between items-center w-full px-4 py-2 bg-white border-b shadow-sm sticky top-0 z-40">
    <div class="flex items-center gap-2">
      @for (layout of chartLayouts; track layout.value) {
        <button
          type="button"
          [title]="layout.name"
          class="w-10 h-10 flex items-center justify-center rounded-full border hover:bg-blue-100 transition"
          [class.bg-blue-200]="selectedChartType() === layout.value"
          (click)="switchLayout(layout.value)"
        >
          <img [src]="layout.icon" [alt]="layout.name" class="w-6 h-6 object-contain" />
        </button>
      }
    </div>

    <!-- Search & Map -->
    <div class="flex items-center gap-2 flex-shrink-0">
      <input
        type="text"
        placeholder="Search number..."
        [value]="searchNumber()"
        (input)="searchNumber.set($event.target.value); onSearch()"
        class="search-input px-3 py-1 border rounded"
      />
      <button type="button" class="view-map-btn px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition" (click)="openMapForNumber()">
        View Map
      </button>
    </div>
  </div>

  <!-- Chart Area -->
  <section class="chart-area flex-1 p-4">
    <div class="relative w-full h-[600px]">
      @if (showNodeMenu()) {
        <div class="node-menu-wrapper absolute top-10 left-10 z-50 bg-white p-4 border rounded shadow-md w-72">
          <h3 class="text-lg font-semibold mb-3">Node Actions</h3>
          <div class="form-group mb-4">
            <label class="block text-sm font-medium mb-1" for="groupName">Group Name</label>
            <input
              id="groupName"
              type="text"
              placeholder="Enter group..."
              [value]="categoryName()"
              (input)="categoryName.set($event.target.value)"
              class="w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div class="flex justify-end gap-3 border-t pt-2">
            <button type="button" class="px-4 py-2 bg-blue-200 text-blue-900 text-sm rounded-md hover:bg-blue-400 hover:text-white transition" (click)="addToGroup()">Add to Group</button>
            <button type="button" class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 transition" (click)="deleteNode()">Delete Node</button>
            <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm rounded-md hover:bg-gray-300 transition" (click)="closeNodeMenu()">Cancel</button>
          </div>
        </div>
      }

      <div id="graph-container" class="w-full h-full border rounded"></div>
    </div>
  </section>

  @if (objectKeys(groups()).length > 0) {
    <div class="card group-card mt-4">
      <h4 class="mb-2 font-semibold">Custom Groups</h4>
      @for (groupName of objectKeys(groups()); track groupName) {
        <div class="bg-gray-100 rounded-lg p-3 shadow-md mb-2">
          <strong class="block mb-1">{{ groupName }}</strong>
          <div class="flex flex-wrap gap-2">
            @for (node of groups()[groupName]; track node.id) {
              <div class="flex items-center gap-1 bg-white border rounded px-2 py-1 text-sm">
                {{ node.label }}
                <button type="button" class="text-red-600 hover:text-red-800 ml-1" title="Remove from group" (click)="onRemoveNodeFromGroup({group: groupName, nodeId: node.id})">âœ•</button>
              </div>
            } @empty {
              <div class="text-sm text-gray-500">No nodes in this group.</div>
            }
          </div>
        </div>
      }
    </div>
  }

  @if (showPopup() && popupData()) {
    <div class="node-popup absolute bg-white border shadow p-4 rounded w-[280px] z-50" [style.top.px]="popupPosition().y" [style.left.px]="popupPosition().x">
      <h4 class="mb-2 font-semibold">Node Details</h4>
      <p><strong>Number:</strong> {{ popupData().label }}</p>
      <p><strong>Operator:</strong> {{ popupData().data?.operator || 'Unknown' }}</p>
      <p><strong>Incoming:</strong> {{ popupData().data?.incomingCount }}</p>
      <p><strong>Outgoing:</strong> {{ popupData().data?.outgoingCount }}</p>
      <p><strong>SMS:</strong> {{ popupData().data?.smsCount }}</p>
      <p><strong>Upload:</strong> {{ popupData().data?.upload }} MB</p>
      <p><strong>Download:</strong> {{ popupData().data?.download }} MB</p>
      <button type="button" class="mt-2 btn btn-sm bg-gray-300 hover:bg-gray-400 rounded px-3 py-1" (click)="closePopup()">Close</button>
    </div>
  }
</div>
